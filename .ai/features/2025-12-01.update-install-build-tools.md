# Feature: update-install-build-tools

**Date:** 2025-12-01
**Feature Name:** update-install-build-tools

## Feature Description

Update the `install_build_tools()` function in `utils/install.sh` to properly install essential build tools across all supported operating systems. The current implementation has several bugs:

1. **macOS:** Currently installs `gh` instead of build tools
2. **Fedora:** Incorrectly calls `install_on_alpine()` instead of `install_on_fedora()`
3. **Arch:** Currently only installs `gh` instead of build tools
4. **Missing logging:** No "installing..." message at the start

### Target Build Tools

Build tools typically include:
- **make** - Build automation tool
- **cmake** - Cross-platform build system
- **gcc/clang** - C/C++ compilers
- **ninja** - Fast build system (optional)
- **just** - Modern command runner (optional, already exists as `install_just()`)

### OS-Specific Requirements

| OS | Primary Package | Compiler | Build Meta-Package |
|----|-----------------|----------|-------------------|
| macOS | xcode-select | clang | N/A (xcode-select provides all) |
| Debian/Ubuntu | make, cmake | gcc/build-essential | build-essential |
| Fedora/RHEL | make, cmake | gcc | @development-tools group |
| Alpine | make, cmake | gcc | alpine-sdk (meta-package) |
| Arch | make, cmake | gcc | base-devel (meta-package) |

## Files Affected

**Modified:**
- `utils/install.sh` - Fix `install_build_tools()` function (lines 889-921)

**Related (read-only reference):**
- `utils/detection.sh` - OS detection utilities (`is_mac`, `is_debian`, etc.)
- `utils/logging.sh` - Logging utilities (`logc`)

## Test Scope

**Glob Pattern:** `tests/*install*.test.ts`

**Test Command:**
```bash
pnpm test tests/install.test.ts
```

## Baseline Test Status

**Run Date:** 2025-12-01

```
Total tests: 46
Passing: 41
Failing: 5 (pre-existing, unrelated to install_build_tools)
```

**Pre-existing failures (NOT ours to fix):**
1. `installed package listing > installed_cargo should list and link packages`
2. `installed package listing > installed_brew should list formulae and casks`
3. `installed package listing > installed should aggregate multiple managers`
4. `installed package listing > should filter output when arguments are provided`
5. `installed package listing > should handle case-insensitive filtering`

These failures are related to output format expectations for `installed_*` functions, not build tools installation logic.

## Implementation Checklist

- [x] Step 1: Preparation (analyze scope, create log)
- [x] Step 2: Planning (design the implementation)
- [x] Step 3: Unit Tests (skipped - bug fix, existing test infra covers behavior)
- [x] Step 4: Implementation (write the code)
- [x] Step 5: Review (self-review for quality)

---

## Step 2: Planning

### Architecture

The `install_build_tools()` function needs to:
1. Check if build tools are already installed (using `make` as the indicator)
2. Log that installation is starting
3. Call the appropriate OS-specific installation logic

### Implementation Plan by OS

#### macOS
- Use `xcode-select --install` for command-line developer tools (provides clang, make, git)
- Alternatively, install via Homebrew: `make`, `cmake`
- The xcode-select approach is preferred as it's Apple's official method

#### Debian/Ubuntu
- Current implementation is mostly correct
- Install: `build-essential` (meta-package with gcc, make, libc-dev)
- Install: `cmake`, `ninja-build` (optional)
- Call: `install_just`

#### Fedora/RHEL
- **FIX:** Change `install_on_alpine` to `install_on_fedora`
- Consider using dnf group install for "@Development Tools"
- Install: `make`, `cmake`, `gcc`
- Call: `install_just`

#### Alpine
- Current implementation is correct
- `alpine-sdk` meta-package provides build tools
- Install: `make`, `cmake`, `gcc` (may be redundant with alpine-sdk)
- Call: `install_just`

#### Arch
- **FIX:** Replace `install_on_arch "gh"` with proper build tools
- Install: `base-devel` (meta-package) via pacman
- Install: `cmake`, `ninja` (optional)
- Call: `install_just`

### Edge Cases

1. **Already installed:** Early exit with message
2. **Partial installation:** The function tries to install multiple packages; if one fails, it continues
3. **No package manager:** Will fail gracefully via `install_on_*` functions

### Dependencies

- `has_command` from detection.sh
- `is_mac`, `is_debian`, `is_ubuntu`, `is_fedora`, `is_alpine`, `is_arch` from detection.sh
- `logc` from logging.sh
- `install_just` from same file (install.sh)
- `install_on_macos`, `install_on_debian`, etc. from same file

---

## Proposed Implementation

```bash
function install_build_tools() {
    if has_command "make"; then
        logc "- {{BOLD}}{{BLUE}}Build Tools{{RESET}} are already installed"
        return 0
    fi

    logc "- installing {{BOLD}}{{BLUE}}Build Tools{{RESET}}"

    if is_mac; then
        # xcode-select provides clang, make, git
        if ! xcode-select -p &>/dev/null; then
            xcode-select --install
        fi
        # Additional tools via Homebrew
        install_on_macos "cmake"
        install_just
    elif is_debian || is_ubuntu; then
        install_on_debian "build-essential"
        install_on_debian "cmake"
        install_on_debian "ninja-build"
        install_just
    elif is_alpine; then
        install_on_alpine "alpine-sdk"
        install_on_alpine "cmake"
        install_just
    elif is_fedora; then
        install_on_fedora "make"
        install_on_fedora "cmake"
        install_on_fedora "gcc"
        install_on_fedora "gcc-c++"
        install_just
    elif is_arch; then
        install_on_arch "base-devel"
        install_on_arch "cmake"
        install_on_arch "ninja"
        install_just
    else
        logc "{{RED}}ERROR:{{RESET}} Unable to automate the install of {{BOLD}}{{BLUE}}Build Tools{{RESET}} on this system"
        return 1
    fi
}
```

---

## Review Findings

**Date:** 2025-12-01

### Bugs Fixed

| OS | Before | After |
|----|--------|-------|
| macOS | `install_on_macos "gh"` (wrong tool) | `xcode-select --install` + `cmake` |
| Fedora | `install_on_alpine` (wrong function!) | `install_on_fedora` with correct packages |
| Arch | `install_on_arch "gh"` (wrong tool) | `base-devel`, `cmake`, `ninja` |

### Code Quality
- [x] Added documentation comment block for the function
- [x] Added "installing..." log message at start
- [x] Uses OS-appropriate meta-packages where available
- [x] Consistent error handling with fallback message
- [x] Follows existing patterns in `install_*` functions

### Test Results
- **Total tests:** 46
- **Passing:** 41
- **Failing:** 5 (same pre-existing failures, no regressions)

### Potential Future Improvements

**Optional:**
- [ ] Add `--minimal` flag to skip optional tools like `ninja` and `just`
- [ ] Add Fedora group install option: `dnf group install "@Development Tools"`
- [ ] Consider waiting for xcode-select dialog to complete on macOS

### Implementation Summary

The function now properly installs build tools on all five supported platforms:

1. **macOS:** Uses `xcode-select --install` for Apple's official dev tools, plus `cmake` via Homebrew
2. **Debian/Ubuntu:** Installs `build-essential` (gcc, g++, make), `cmake`, `ninja-build`
3. **Alpine:** Uses `alpine-sdk` meta-package plus `cmake`
4. **Fedora:** Installs individual packages: `make`, `cmake`, `gcc`, `gcc-c++`
5. **Arch:** Uses `base-devel` meta-package plus `cmake`, `ninja`

All paths also call `install_just` for the modern command runner.
