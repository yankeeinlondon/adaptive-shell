# Feature: Network Interfaces & IP Address Highlighting

**Date:** 2025-12-01
**Feature Name:** `network-interfaces-highlight`

## Feature Description

This feature enhances the `utils/network.sh` module with:

1. **Windows support for `network_interfaces()`** - Add a conditional block to support Windows environments (via WSL/Git Bash) using PowerShell's `Get-NetIPAddress` cmdlet
2. **`highlight_ip_addresses()` function** - Process a stream of text and highlight any IPv4 and IPv6 addresses with configurable formatting (defaults to `{{BOLD}}`)
3. **Enhanced `network_interfaces()` output** - Pipe the output through `highlight_ip_addresses()` so IP addresses are visually highlighted

### Example Output (macOS)

Current output:
```
inet 127.0.0.1 netmask 0xff000000
inet 192.168.10.65 netmask 0xffffff00 broadcast 192.168.10.255
inet 192.168.100.47 netmask 0xffffff00 broadcast 192.168.100.255
```

Enhanced output (with bold IP addresses):
```
inet **127.0.0.1** netmask 0xff000000
inet **192.168.10.65** netmask 0xffffff00 broadcast **192.168.10.255**
inet **192.168.100.47** netmask 0xffffff00 broadcast **192.168.100.255**
```

## Files Affected

### Files to Modify

- `utils/network.sh` - Main implementation (lines 235-256 need updates)

### Dependencies

- `utils/os.sh` - Already imported (provides `os()` function)
- `utils/color.sh` - Will need to be imported (provides `colorize()` function)

## Test Scope

```bash
# Test command
pnpm test tests/pve-network.test.ts

# Glob pattern for affected tests
tests/*network*.test.ts
```

## Baseline Test Status

```
Tests in scope: tests/pve-network.test.ts
Total tests: 99
Passing: 99
Failing: 0
```

No pre-existing test failures.

## Implementation Checklist

- [ ] Step 2: Planning (design detailed implementation)
- [ ] Step 3: Create unit tests
- [ ] Step 4: Implementation
- [ ] Step 5: Review

---

## Architecture & Design

### Windows Network Interface Detection

**Research:**
- Windows supports `ipconfig` natively but output is verbose
- PowerShell provides `Get-NetIPAddress` for structured IP information
- In Git Bash/WSL environments, `powershell.exe` or `cmd.exe` can be called directly

**PowerShell Commands:**

```powershell
# Get all IPv4 addresses
Get-NetIPAddress -AddressFamily IPv4 | Select-Object InterfaceAlias, IPAddress

# Simple output format similar to Linux/macOS
Get-NetIPAddress -AddressFamily IPv4 | ForEach-Object { "inet $($_.IPAddress)" }
```

**Implementation Strategy:**

For the `network_interfaces()` function, add a Windows branch:

```bash
elif [[ "$(os)" == "windows" ]]; then
    powershell.exe -Command "Get-NetIPAddress -AddressFamily IPv4 | ForEach-Object { Write-Output (\"inet \" + \$_.IPAddress) }" 2>/dev/null | tr -d '\r'
fi
```

### highlight_ip_addresses() Function

**Purpose:** Process text input and wrap any IPv4/IPv6 addresses with formatting tags.

**Input:**
- `$1` (content): The text to process (from stdin if not provided)
- `$2` (format): The format tag to apply (default: `{{BOLD}}`)

**Output:** Text with IP addresses wrapped in format tags

**Algorithm:**

1. Read input line by line
2. For each line, use regex to find IP addresses
3. Replace each IP address with `${format}IP_ADDRESS{{RESET}}`
4. Output the processed line

**IP Address Patterns:**

IPv4: `[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}`

IPv6 is more complex due to compressed notation. A simplified approach:
- Full form: `[0-9a-fA-F:]+` with colons
- Need to avoid matching partial hex strings

**IPv6 Support:**

IPv6 addresses are more complex due to:
- Full form: `2001:0db8:85a3:0000:0000:8a2e:0370:7334`
- Compressed form: `2001:db8::8a2e:370:7334`
- Loopback: `::1`
- All zeros: `::`
- IPv4-mapped: `::ffff:192.168.1.1`
- Zone identifiers: `fe80::1%eth0`

**Strategy:** Use the existing `is_ip4_address()` and `is_ip6_address()` validation functions from `utils/network.sh` to validate potential matches. This is more reliable than complex regex patterns.

**Alternative approach using word boundary matching:**
- Extract potential IP-like patterns (words with dots, colons, or hex digits)
- Validate each candidate using the existing validation functions
- Wrap valid IP addresses with format tags

**Implementation approach (hybrid sed + validation):**

Since we have reliable `is_ip4_address()` and `is_ip6_address()` functions, we can:
1. Use sed with broad patterns to identify candidates
2. For IPv6, use a word-based approach since sed regex is limited

**Implementation:**

```bash
# highlight_ip_addresses [format]
#
# Reads from stdin, highlights IPv4 and IPv6 addresses with the specified format.
# Default format is {{BOLD}}.
function highlight_ip_addresses() {
    local format="${1:-{{BOLD}}}"
    local line result word

    # Source color utilities
    source "${UTILS}/color.sh"
    setup_colors

    while IFS= read -r line || [[ -n "$line" ]]; do
        result=""
        # Process each word/token in the line
        # Need to preserve whitespace and structure

        # Use sed for IPv4 (simpler pattern)
        # IPv4 pattern - matches potential IPv4 addresses
        local ipv4_pattern='[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*'

        # For IPv6, we need a more sophisticated approach
        # Match hex:hex patterns and validate
        local ipv6_pattern='[0-9a-fA-F:]*:[0-9a-fA-F:]*'

        # Apply IPv4 highlighting
        line=$(echo "$line" | sed "s/${ipv4_pattern}/${format}&{{RESET}}/g")

        # For IPv6, use a callback-style replacement (more complex)
        # ... implementation details

        printf '%s\n' "$(colorize "$line")"
    done
}
```

**Recommended approach:** For simplicity and reliability, use sed patterns for both IPv4 and IPv6, with carefully crafted patterns to minimize false positives.

### Integration with network_interfaces()

After getting the base output, pipe through `highlight_ip_addresses()`:

```bash
function network_interfaces() {
    source "${UTILS}/os.sh"
    source "${UTILS}/color.sh"
    setup_colors

    local output=""

    if [[ "$(os)" == "macos" ]]; then
        output=$(ifconfig | grep "inet ")
    elif [[ "$(os)" == "linux" ]]; then
        output=$(ip addr show | grep "inet ")
    elif [[ "$(os)" == "windows" ]]; then
        output=$(powershell.exe -Command "Get-NetIPAddress -AddressFamily IPv4 | ForEach-Object { Write-Output (\"inet \" + \$_.IPAddress) }" 2>/dev/null | tr -d '\r')
    fi

    echo "$output" | highlight_ip_addresses
}
```

### Implementation Steps

1. **Add `highlight_ip_addresses()` function**
   - Implement using sed for IPv4 pattern matching
   - Support custom format parameter
   - Pipe input through `colorize()` for tag conversion

2. **Update `network_interfaces()` function**
   - Add Windows conditional branch
   - Source `color.sh` for `colorize()`
   - Call `setup_colors` to ensure color variables are set
   - Pipe output through `highlight_ip_addresses()`

3. **Test edge cases**
   - Empty input
   - No IP addresses in input
   - Multiple IP addresses on same line
   - IPv4 boundary values (0.0.0.0, 255.255.255.255)

### Dependencies

- `utils/color.sh` - for `colorize()` and `setup_colors`
- `utils/os.sh` - for `os()` detection (already imported)
- `sed` - standard utility available on all platforms

### Testing Considerations

**Testable aspects:**
- `highlight_ip_addresses()` output formatting
- IPv4 address detection in various text contexts
- Format parameter customization
- Empty input handling

**Challenging to test:**
- Actual Windows output (requires Windows environment)
- Terminal color rendering (visual verification)

**Testing strategy:**
- Test `highlight_ip_addresses()` with mock input
- Verify IP addresses are wrapped with correct tags
- Test with environment variables to control colors

---

## Test Details

### Test Summary

**Test File Created:** `/Users/ken/config/sh/tests/network.test.ts`

**Total Test Cases:** 36 test cases organized in 10 describe blocks

**Test Coverage:**

1. **IPv4 Highlighting (9 tests)**
   - Single IPv4 address
   - Multiple IPv4 addresses on one line
   - IPv4 at start/end of line
   - IPv4 with surrounding punctuation
   - Special addresses: loopback (127.0.0.1), broadcast (255.255.255.255), zero address (0.0.0.0)
   - Multiple addresses across lines

2. **IPv6 Highlighting (7 tests)**
   - Full IPv6 address (2001:0db8:85a3:0000:0000:8a2e:0370:7334)
   - Compressed IPv6 (2001:db8::1)
   - Loopback IPv6 (::1)
   - All zeros IPv6 (::)
   - IPv4-mapped IPv6 (::ffff:192.168.1.1)
   - IPv6 with zone identifier (fe80::1%eth0)
   - Link-local address

3. **Mixed IPv4 and IPv6 (2 tests)**
   - Both on same line
   - Mixed across multiple lines

4. **Custom Format Parameter (4 tests)**
   - Custom format tags: RED, UNDERLINE, DIM
   - Combined format tags (BOLD + BLUE)

5. **Edge Cases (8 tests)**
   - Empty input
   - Text with no IP addresses
   - Invalid IPv4 (out of range: 256.256.256.256)
   - Partial IP addresses (1.2.3)
   - Whitespace preservation
   - Complex text formats (ifconfig-style)
   - Hex values should not be highlighted

6. **Realistic Network Interface Output (3 tests)**
   - macOS ifconfig output
   - Linux ip addr output
   - Multi-line interface output

7. **Colorize Integration (2 tests)**
   - ANSI codes after colorize processing
   - Custom format with colorize

8. **Default Format Behavior (2 tests)**
   - Default to BOLD when no format specified
   - Default to BOLD when empty string passed

### Testing Approach

Since `highlight_ip_addresses()` reads from stdin, the tests use the deprecated `sourcedBash()` helper with piping:

```typescript
const result = sourcedBash('./utils/network.sh', 'echo "test 192.168.1.1" | highlight_ip_addresses')
```

### Test Status

**Current Status:** All 36 tests created and ready
- 33 tests failing (expected - function not yet implemented)
- 3 tests passing (edge cases that pass with empty output)

**When Implementation Complete:**
- All tests should pass
- Tests verify tag placement before colorization
- Tests verify integration with colorize() for ANSI output

### Dependencies Tested

The tests verify:
- `highlight_ip_addresses()` function behavior
- Integration with `colorize()` from `utils/color.sh`
- Default format parameter handling
- Custom format parameter handling

### Not Tested

As specified in requirements:
- Windows `network_interfaces()` implementation (requires Windows environment)
- Visual terminal output appearance (requires human verification)

### Test Execution

```bash
# Run network tests only
pnpm test tests/network.test.ts

# Run all network-related tests
pnpm test tests/*network*.test.ts
```

---

## Review Findings

### Code Quality: Good

**Strengths:**
- Functions follow repo conventions (lowercase with underscores)
- Local variables properly declared with `local`
- Well-documented with comment blocks describing purpose, parameters, and usage
- Leverages existing validation functions (`is_ip4_address`, `is_ip6_address`) for reliable IP detection
- Character-by-character parsing ensures accurate token extraction

**Function Documentation:**
- `highlight_ip_addresses` has comprehensive comment block with usage examples
- `network_interfaces` updated with clear description of platform support

### Shell Compatibility

**Bash:** Fully compatible (Bash 3.x+)
- Uses only standard bash string operations
- No arrays with `read -ra` that would fail in zsh

**Zsh:** Compatible via `is_ip4_address` and `is_ip6_address` (though those functions have a known zsh issue with `read -ra` that should be addressed separately)

### Security: No Issues

- [x] No command injection risks
- [x] IP validation uses existing trusted functions
- [x] PowerShell command properly escapes special characters
- [x] No user input passed to shell execution

### Performance

The implementation uses a character-by-character parsing approach which is O(n) where n is the length of input. For typical network output (a few lines), this is negligible. For very large inputs, performance could be improved but is not a concern for the intended use case.

### Test Coverage: Comprehensive

**36 test cases covering:**
- IPv4 highlighting (single, multiple, special addresses)
- IPv6 highlighting (full, compressed, loopback, IPv4-mapped, zone identifiers)
- Mixed IPv4 and IPv6 addresses
- Custom format parameters
- Edge cases (empty input, no IPs, invalid addresses)
- Realistic network output (macOS ifconfig, Linux ip addr)
- Colorize integration

### Implementation Checklist

- [x] Step 2: Planning (design detailed implementation)
- [x] Step 3: Create unit tests (36 tests created)
- [x] Step 4: Implementation
- [x] Step 5: Review

### Final Test Status

```
Tests in scope: tests/network.test.ts + tests/pve-network.test.ts
Total tests: 135
Passing: 135
Failing: 0
```

### Potential Future Improvements (Optional)

- [ ] **Address the zsh `read -ra` issue** in `is_ip4_address` and `is_ip6_address`
  - Priority: Low (affects zsh users only)
  - Note: The `highlight_ip_addresses` function itself is zsh-compatible

- [ ] **Performance optimization** for very large inputs
  - Priority: Optional
  - Current implementation is fine for typical network output
