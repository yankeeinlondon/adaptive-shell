# Feature: Windows Installation Support

## Feature Description

Add Windows installation support to `install_jq()`, `install_curl()`, and `install_yq()` functions in `utils/install.sh`. This enables these common CLI tools to be automatically installed on Windows systems using the existing `is_windows()` detection and a new `install_on_windows()` helper function.

Windows installation will use **winget** (Windows Package Manager) as the primary package manager, with **Chocolatey** and **Scoop** as fallbacks. These are the three most common package managers for Windows CLI tools.

## Files Affected

### Modified Files
- `utils/install.sh` - Add `install_on_windows()` function and Windows branches to:
  - `install_jq()`
  - `install_curl()`
  - `install_yq()`

### Test Files
- `tests/unit/install.test.ts` - Existing tests (may need mock updates)
- `tests/unit/WIP/install-windows.test.ts` - New tests for Windows support
- `tests/helpers/install-mocks.sh` - May need Windows package manager mocks

## Test Scope

**Glob Pattern:** `tests/unit/*install*.test.ts`

**Test Command:**
```bash
pnpm test tests/unit/install.test.ts tests/unit/WIP/install-windows.test.ts
```

## Baseline Test Status

```bash
pnpm test tests/unit/install.test.ts
```

- **Total tests in scope:** 53 tests
- **Passing:** 53
- **Failing:** 0
- **Pre-existing failures:** None

## Implementation Checklist

- [x] Step 2: Planning - Design `install_on_windows()` and integration approach
- [x] Step 3: Unit Tests - Create comprehensive tests for Windows installation
- [x] Step 4: Implementation - Implement Windows support
- [x] Step 5: Review - Self-review and document findings

---

## Step 2: Planning

### Architecture

The implementation follows the existing pattern established by `install_on_macos()`, `install_on_debian()`, etc.

**New Helper Function:**
```bash
# install_on_windows [--prefer-choco] [--prefer-scoop] <pkg> [<pkg2>] ...
#
# Attempts to install packages on Windows using available package managers.
# Priority order: winget > chocolatey > scoop
# Flags allow preferring alternative package managers.
function install_on_windows() {
    # ...
}
```

**Package Manager Priority:**
1. **winget** (Windows Package Manager) - Built into Windows 10/11, official Microsoft tool
2. **Chocolatey** - Most popular third-party Windows package manager
3. **Scoop** - Developer-focused package manager, installs to user directory

### Implementation Steps

1. **Add Windows package manager mocks** to `tests/helpers/install-mocks.sh`:
   - Mock `winget` commands (search, install)
   - Mock `choco` commands (search, install)
   - Mock `scoop` commands (search, install)

2. **Create `install_on_windows()` function:**
   - Parse flags (`--prefer-choco`, `--prefer-scoop`)
   - Validate that at least one package name is provided
   - Try each package manager in priority order
   - Support multiple package name variants (like other `install_on_*` functions)

3. **Update `install_jq()`:**
   - Add `elif is_windows; then install_on_windows "jq"` branch
   - Package names: `jq` (winget: `jqlang.jq`, choco: `jq`, scoop: `jq`)

4. **Update `install_curl()`:**
   - Add `elif is_windows; then install_on_windows "curl"` branch
   - Note: curl is typically pre-installed on Windows 10+, but function should handle installation if needed
   - Package names: `curl` (winget: `cURL.cURL`, choco: `curl`, scoop: `curl`)

5. **Update `install_yq()`:**
   - Add `elif is_windows; then install_on_windows "yq"` branch
   - Package names: `yq` (winget: `MikeFarah.yq`, choco: `yq`, scoop: `yq`)

### Type Definitions

N/A - This is a bash shell script project.

### Edge Cases

1. **No package manager available:** Return error with helpful message
2. **Package name variants:** Some packages have different names across managers (e.g., `jqlang.jq` vs `jq`)
3. **WSL vs native Windows:** The `is_windows()` function already handles this distinction
4. **Elevated permissions:** winget and chocolatey may require admin rights; scoop typically doesn't
5. **PowerShell execution policy:** May affect script-based installers

### Dependencies

- No new dependencies required
- Existing `is_windows()` function from `utils/os.sh` is already available
- Existing color/logging utilities are already available

### Package Name Mapping

| Tool | winget ID | Chocolatey | Scoop |
|------|-----------|------------|-------|
| jq   | `jqlang.jq` | `jq` | `jq` |
| curl | `cURL.cURL` | `curl` | `curl` |
| yq   | `MikeFarah.yq` | `yq` | `yq` |

---

## Test Details

**Test File:** `tests/unit/WIP/install-windows.test.ts`

**Test Categories:**
1. **Error handling** (2 tests)
   - No package provided
   - Only flags provided

2. **Package manager priority** (5 tests)
   - Winget first when available
   - Fall back to Chocolatey when winget doesn't have package
   - Fall back to Scoop when winget and choco don't have package
   - Return failure if no package manager has the package
   - Return failure when no package managers are available

3. **--prefer-choco flag** (2 tests)
   - Try chocolatey first when --prefer-choco is set
   - Fall back to other managers if choco fails

4. **--prefer-scoop flag** (2 tests)
   - Try scoop first when --prefer-scoop is set
   - Fall back to other managers if scoop fails

5. **Multiple package name variants** (2 tests)
   - Try each package name in order until one succeeds
   - Return failure if no package variant is found

6. **Flag position flexibility** (3 tests)
   - Accept flags at beginning
   - Accept flags in middle
   - Accept flags at end

7. **Install functions with Windows support** (3 tests)
   - install_jq() with Windows
   - install_curl() with Windows
   - install_yq() with Windows

**Total Tests:** 19 tests (all passing)

**Mock Infrastructure Updates:**
- Added `winget()` mock with `search` and `install` subcommands
- Added `choco()` mock with `search` and `install` subcommands
- Added `scoop()` mock with `search` and `install` subcommands

---

## Review Findings

### Implementation Summary

Successfully implemented Windows installation support with the following changes:

1. **New function `install_on_windows()`** (`utils/install.sh:864-971`)
   - Follows the same pattern as `install_on_macos()`, `install_on_debian()`, etc.
   - Supports `--prefer-choco` and `--prefer-scoop` flags
   - Priority order: winget > chocolatey > scoop
   - Accepts multiple package name variants

2. **Updated install functions:**
   - `install_jq()` - Added Windows branch using `jqlang.jq` (winget ID) and `jq`
   - `install_curl()` - Added Windows branch using `cURL.cURL` (winget ID) and `curl`
   - `install_yq()` - Added Windows branch using `MikeFarah.yq` (winget ID) and `yq`

3. **Mock infrastructure updates** (`tests/helpers/install-mocks.sh`)
   - Added mocks for `winget`, `choco`, and `scoop` commands

### Test Results

```
Tests: 19 passed (19 new Windows tests)
Original tests: 53 passed (no regressions)
Total: 72 tests passing
```

### Design Decisions

1. **No piping in search commands:** The implementation uses `command search "$pkg" &>/dev/null` rather than piping to grep. This is necessary because piped commands run in subshells and cannot record mock calls, which would break testing.

2. **Package ID variants:** Windows package managers (especially winget) use different package IDs than the simple package names. The implementation passes both the specific winget ID (e.g., `jqlang.jq`) and the common name (e.g., `jq`) to handle different package manager conventions.

3. **No nix/cargo fallbacks on Windows:** Unlike other platforms, Windows doesn't have nix or cargo as common fallback options, so these were intentionally omitted.

### Future Considerations

1. **Elevated permissions:** winget and chocolatey may require admin rights for some packages; scoop typically doesn't. The current implementation doesn't handle UAC prompts.

2. **WSL detection:** The existing `is_windows()` function already distinguishes between native Windows and WSL, so this implementation only activates on native Windows.

3. **Additional Windows tools:** Future work could add Windows support to other install functions (e.g., `install_gh()`, `install_wget()`, etc.) following the same pattern.
