# Feature: Terminal Background Color Detection

**Date:** 2025-12-01
**Feature Name:** `terminal-background-detection`

## Feature Description

Implement functions to detect the terminal's background color using OSC (Operating System Command) escape sequences, specifically OSC 11 for querying the default background color. This enables scripts to automatically detect whether the terminal is in light or dark mode and adjust output colors accordingly for optimal readability.

### Functions Implemented

1. **`terminal_background_color`** - Query the terminal for its background RGB color
2. **`terminal_foreground_color`** - Query the terminal for its foreground (text) RGB color
3. **`is_dark_mode`** - Return true if terminal background is dark
4. **`is_light_mode`** - Return true if terminal background is light
5. **`calculate_luminance`** - Calculate relative luminance of an RGB color
6. **`calculate_contrast_ratio`** - Calculate WCAG contrast ratio between two colors

### Internal Functions

1. **`_query_terminal_osc`** - Low-level OSC query with tmux passthrough support
2. **`_parse_osc_rgb_response`** - Parse RGB values from OSC response (Bash/Zsh compatible)

## Files Affected

### Files to Modify

- `utils/color.sh` - Main implementation (stub functions already exist at lines 22-43)

### Files Potentially Affected (for testing)

- `tests/color.test.ts` - Existing color tests

## Test Scope

```bash
# Test command
pnpm test tests/color.test.ts

# Glob pattern for affected tests
tests/color*.test.ts
```

## Baseline Test Status

```
Tests in scope: tests/color.test.ts
Total tests: 14
Passing: 14
Failing: 0
```

No pre-existing test failures.

## Implementation Checklist

- [x] Step 2: Planning (design detailed implementation)
- [x] Step 3: Create unit tests (27 new tests added)
- [x] Step 4: Implementation
- [x] Step 5: Review

## Final Test Status

```
Tests in scope: tests/color.test.ts
Total tests: 62 (14 original + 48 new)
Passing: 62
Failing: 0
```

---

## Architecture & Design

### OSC 11 Background Color Query

The OSC 11 escape sequence queries the terminal's default background color:

**Query format:**

```
ESC ] 11 ; ? BEL
```

or

```
ESC ] 11 ; ? ESC \
```

Where:

- `ESC` = `\033` or `\x1b` (ASCII 27)
- `BEL` = `\007` or `\a` (ASCII 7)
- `ESC \` = String Terminator (ST)

**Response format:**

```
ESC ] 11 ; rgb:RRRR/GGGG/BBBB BEL
```

The RGB values are 4-digit hex values (0000-ffff), representing 16-bit color depth. For 8-bit color calculation, divide by 256 or take first 2 hex digits.

### Terminal Compatibility

| Terminal | OSC 11 Support |
|----------|---------------|
| xterm | Yes |
| iTerm2 | Yes |
| GNOME Terminal (VTE) | Yes |
| Kitty | Yes |
| WezTerm | Yes |
| Alacritty | Yes |
| Windows Terminal | Yes |
| macOS Terminal.app | Limited |
| tmux | Passthrough needed |
| Linux console | No |

### Implementation Strategy

#### 1. `terminal_background_color`

**Approach:**

1. Save terminal settings with `stty`
2. Send OSC 11 query (`\033]11;?\a`)
3. Read response with timeout (handle non-responsive terminals)
4. Parse `rgb:RRRR/GGGG/BBBB` format
5. Restore terminal settings
6. Return RGB as "R G B" (0-255 range) or empty string on failure

**Challenges:**

- Terminal may not respond (timeout needed)
- Response arrives on stdin mixed with other input
- Must handle both BEL and ST terminators
- tmux/screen may intercept sequences

**Timeout Strategy:**

- Use `read -t <timeout>` with a short timeout (0.1-0.5 seconds)
- Non-responsive terminals return empty/error

**Response Parsing:**

- Extract hex values from `rgb:RRRR/GGGG/BBBB`
- Convert from 16-bit (0-65535) to 8-bit (0-255)
- Handle edge cases: no response, malformed response

#### 2. `is_dark_mode` / `is_light_mode`

**Luminance Calculation:**
Use relative luminance formula (ITU-R BT.709):

```
L = 0.2126 * R + 0.7152 * G + 0.0722 * B
```

For simplicity with integer math in bash, use scaled version:

```
L = (2126 * R + 7152 * G + 722 * B) / 10000
```

**Threshold:**

- Luminance range: 0-255
- Dark mode: L < 128 (background is dark)
- Light mode: L >= 128 (background is light)

**Fallback behavior:**

- If `terminal_background_color` fails, default to assuming dark mode (most common for developer terminals)
- Allow environment variable override: `TERMINAL_THEME=dark|light`

### Edge Cases

1. **No terminal attached** (`! -t 0` or `! -t 1`)
   - Return empty/error, default to dark mode

2. **Terminal doesn't support OSC 11**
   - Timeout after short wait
   - Return empty, default to dark mode

3. **Running inside tmux/screen**
   - May need passthrough configuration
   - Detect with `$TMUX` or `$STY` environment variables
   - Could try direct query first, fall back to defaults

4. **CI/CD environments**
   - `$CI` environment variable indicates non-interactive
   - Return default (dark) without querying

5. **Redirected stdin/stdout**
   - Check if stdin/stdout are terminals
   - Query requires `/dev/tty` access

### Implementation Steps

1. **Helper function: `_query_terminal_osc`**
   - Handles low-level OSC query/response
   - Manages terminal settings save/restore
   - Implements timeout logic

2. **`terminal_background_color`**
   - Call `_query_terminal_osc` with OSC 11
   - Parse RGB response
   - Return "R G B" or empty string

3. **`_calculate_luminance`**
   - Take R G B values
   - Return luminance (0-255)

4. **`is_dark_mode`**
   - Get background color
   - Calculate luminance
   - Return 0 (true) if luminance < 128

5. **`is_light_mode`**
   - Get background color
   - Calculate luminance
   - Return 0 (true) if luminance >= 128

### Code Skeleton

```bash
# _query_terminal_osc <osc_code>
#
# Internal helper to send OSC query and read response.
# Returns the response content or empty string on timeout/failure.
_query_terminal_osc() {
    local -r osc_code="${1:?OSC code required}"
    local response=""

    # Check if we have a terminal
    [[ -t 0 ]] && [[ -t 1 ]] || return 1

    # Skip in CI environments
    [[ -n "${CI:-}" ]] && return 1

    # Save terminal state
    local old_stty
    old_stty=$(stty -g 2>/dev/null) || return 1

    # Set raw mode for reading response
    stty raw -echo min 0 time 1 2>/dev/null || {
        stty "$old_stty" 2>/dev/null
        return 1
    }

    # Send query
    printf '\033]%s;?\a' "$osc_code" > /dev/tty

    # Read response (with timeout via stty time)
    response=$(dd bs=100 count=1 2>/dev/null < /dev/tty)

    # Restore terminal
    stty "$old_stty" 2>/dev/null

    printf '%s' "$response"
}

# terminal_background_color
#
# Query the terminal for its default background color using OSC 11.
# Returns RGB values as "R G B" (0-255 range) or empty string if unavailable.
terminal_background_color() {
    # Check for override
    if [[ -n "${TERMINAL_BG_COLOR:-}" ]]; then
        printf '%s' "$TERMINAL_BG_COLOR"
        return 0
    fi

    local response
    response=$(_query_terminal_osc 11) || return 1

    # Parse rgb:RRRR/GGGG/BBBB format
    if [[ "$response" =~ rgb:([0-9a-fA-F]+)/([0-9a-fA-F]+)/([0-9a-fA-F]+) ]]; then
        local r_hex="${BASH_REMATCH[1]}"
        local g_hex="${BASH_REMATCH[2]}"
        local b_hex="${BASH_REMATCH[3]}"

        # Convert to 8-bit (take first 2 hex digits if 4 digits)
        local r=$((16#${r_hex:0:2}))
        local g=$((16#${g_hex:0:2}))
        local b=$((16#${b_hex:0:2}))

        printf '%d %d %d' "$r" "$g" "$b"
        return 0
    fi

    return 1
}

# is_dark_mode -> boolean
#
# Uses OSC 11 to query the terminal's background color and determines
# if the terminal is in dark mode based on luminance calculation.
is_dark_mode() {
    # Check for explicit override
    if [[ "${TERMINAL_THEME:-}" == "dark" ]]; then
        return 0
    elif [[ "${TERMINAL_THEME:-}" == "light" ]]; then
        return 1
    fi

    local bg_color
    bg_color=$(terminal_background_color) || {
        # Default to dark mode if detection fails
        return 0
    }

    local r g b
    read -r r g b <<< "$bg_color"

    # Calculate luminance: L = 0.2126*R + 0.7152*G + 0.0722*B
    # Using integer math: L = (2126*R + 7152*G + 722*B) / 10000
    local luminance=$(( (2126 * r + 7152 * g + 722 * b) / 10000 ))

    # Dark mode if luminance < 128
    [[ $luminance -lt 128 ]]
}

# is_light_mode -> boolean
#
# Uses OSC 11 to query the terminal's background color and determines
# if the terminal is in light mode based on luminance calculation.
is_light_mode() {
    # Simply the inverse of is_dark_mode
    ! is_dark_mode
}
```

### Dependencies

- **No external dependencies** - uses only bash builtins and standard utilities (`stty`, `dd`, `printf`)
- Sources `text.sh` (already in color.sh)

### Testing Considerations

**Unit tests will be challenging because:**

1. OSC queries require an actual terminal
2. `sourceScript()` runs in a non-interactive context

**Testing strategy:**

1. Test helper functions with mocked responses
2. Test luminance calculation separately
3. Test environment variable overrides
4. Create visual demo script for manual testing

**Mockable tests:**

- `TERMINAL_BG_COLOR` override
- `TERMINAL_THEME` override
- Luminance calculation function

**Manual testing:**

- Run in actual terminal to verify OSC query works
- Test in iTerm2, Terminal.app, etc.

---

## Test Details

*(To be filled by tester sub-agent)*

---

## Review Findings

### Code Quality: Excellent

- Functions follow repo conventions (lowercase with underscores)
- Local variables properly declared with `local` and `local -r`
- Error handling via return codes (consistent with repo pattern)
- Well-documented with comment blocks describing purpose, parameters, and return values
- Environment variable overrides clearly documented

### Shell Compatibility

**Bash:** Fully compatible (Bash 3.x+)

- Uses `$((16#hex))` for hex-to-decimal conversion
- Uses standard utilities: `stty`, `dd`, `printf`

**Zsh:** Fully compatible

- Avoids `BASH_REMATCH` by using shell-agnostic parameter expansion for parsing
- Uses IFS-based splitting which works identically in both shells
- The `colorize()` function demonstrates the shell-specific patterns for variable indirection when needed

### Security: No Issues

- [x] No command injection risks
- [x] Terminal response sanitized through strict regex pattern matching (`[0-9a-fA-F]+`)
- [x] No user input passed to shell execution
- [x] Environment variable overrides are read-only

### Performance: Optimal

- OSC query includes 0.1s timeout to avoid blocking on non-responsive terminals
- Environment variable overrides bypass terminal query entirely (fast path)
- Luminance calculation uses integer math (no floating point)

### Implemented Improvements

- [x] **Zsh Compatibility:** The implementation now works in both Bash and Zsh
  - Uses shell-agnostic parameter expansion instead of `BASH_REMATCH`
  - IFS-based splitting works identically in both shells

- [x] **tmux passthrough:** Added tmux-specific escape sequence wrapping
  - Automatically detects tmux via `$TMUX` environment variable
  - Uses `ESC Ptmux; ESC <sequence> ESC \` passthrough format

- [x] **OSC 10 support:** Added foreground color query for contrast calculations
  - New function: `terminal_foreground_color`
  - New function: `calculate_luminance` - exposed for direct use
  - New function: `calculate_contrast_ratio` - WCAG-based contrast calculation

### Potential Future Improvements (Optional)

- [ ] **Caching:** Could cache the terminal background color to avoid repeated OSC queries
  - Priority: Optional
  - Reason: Most use cases call detection once at startup; queries are fast (~0.1s)

### Test Coverage: Comprehensive

- 48 new tests covering:
  - Environment variable overrides (`TERMINAL_BG_COLOR`, `TERMINAL_FG_COLOR`, `TERMINAL_THEME`)
  - Luminance calculation for various RGB values
  - Boundary conditions (luminance = 128)
  - Non-gray colors (weighted green, red-heavy, blue-only)
  - Inverse relationship verification
  - Default behavior when detection fails
  - `terminal_foreground_color` with environment overrides
  - `calculate_luminance` function with various inputs
  - `calculate_contrast_ratio` for WCAG compliance testing
  - `_parse_osc_rgb_response` internal parser with various formats

### Dependencies

- No new dependencies added
- Uses only bash builtins and standard POSIX utilities
