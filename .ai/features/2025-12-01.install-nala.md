# Feature: install_nala()

**Date:** 2025-12-01
**Feature Name:** install-nala

## Feature Description

Implement the `install_nala()` function in `utils/install.sh` to install the [Nala](https://gitlab.com/volian/nala) package manager frontend for APT on Debian/Ubuntu systems. Nala provides a better user experience than plain apt with features like:
- Parallel package downloads
- Ability to select fastest mirrors via `nala fetch`
- Colorized, cleaner output
- Transaction history

The function should:
1. Check if nala is already installed (skip if so)
2. Detect the OS (Debian/Ubuntu) and version
3. Use the appropriate installation method:
   - Debian 11+ / Ubuntu 22.04+: Install directly from official repos
   - Older versions: Use the Volian Scar third-party repository
4. Optionally run `nala fetch` to select fast mirrors (with user confirmation)

## Files Affected

**Modified:**
- `utils/install.sh` - Replace the stub `install_nala()` function (lines 991-1007)

**Related (read-only reference):**
- `programs/initialize.sh` - Contains the older `get_nala()` function for reference
- `utils/detection.sh` - OS detection utilities
- `utils/logging.sh` - Logging utilities (`logc`, `log`)
- `utils/interactive.sh` - User interaction (`confirm`)

## Test Scope

**Glob Pattern:** `tests/*install*.test.ts`

**Test Command:**
```bash
pnpm test tests/install.test.ts
```

## Baseline Test Status

**Run Date:** 2025-12-01

```
Total tests: 46
Passing: 41
Failing: 5 (pre-existing, unrelated to install_nala)
```

**Pre-existing failures (NOT ours to fix):**
1. `installed package listing > installed_cargo should list and link packages`
2. `installed package listing > installed_brew should list formulae and casks`
3. `installed package listing > installed should aggregate multiple managers`
4. `installed package listing > should filter output when arguments are provided`
5. `installed package listing > should handle case-insensitive filtering`

These failures are related to output format expectations for `installed_*` functions, not installation logic.

## Implementation Checklist

- [ ] Step 2: Planning (design the implementation)
- [ ] Step 3: Unit Tests (delegate to tester sub-agent)
- [ ] Step 4: Implementation (write the code)
- [ ] Step 5: Review (self-review for quality)

---

## Step 2: Planning

### Architecture

The `install_nala()` function will follow the established pattern of other `install_*` functions in the codebase:

1. **Early exit if installed:** Check `has_command "nala"` first
2. **OS-specific installation:** Only install on Debian/Ubuntu systems
3. **Version-aware installation:**
   - Modern systems (Debian 11+, Ubuntu 22.04+): Use standard APT repos
   - Legacy systems: Use Volian Scar repository
4. **Mirror selection:** Optionally prompt for `nala fetch` after installation

### Implementation Steps

1. Check if nala is already installed using `has_command "nala"`
2. Validate the OS is Debian or Ubuntu using `is_debian()` / `is_ubuntu()`
3. Get OS version using `os_version()`
4. Determine installation method:
   - For Debian 11+ or Ubuntu 22.04+: Use `install_on_debian "nala"`
   - For older versions: Install via Volian Scar repository
5. If Volian Scar is needed:
   - Ensure prerequisites (curl, gpg) are available
   - Import GPG key
   - Add repository to sources.list.d
   - Update apt and install nala
6. After successful installation, optionally offer to run `nala fetch` for mirror optimization

### Helper Function Needed

A helper function `_install_nala_from_volian()` to encapsulate the Volian Scar repository setup:

```bash
_install_nala_from_volian() {
    # Import GPG key
    curl -fSsL https://deb.volian.org/volian/scar.key | gpg --dearmor | \
        ${SUDO} tee /usr/share/keyrings/volian.gpg > /dev/null

    # Add repository
    echo "deb [signed-by=/usr/share/keyrings/volian.gpg] https://deb.volian.org/volian/ scar main" | \
        ${SUDO} tee /etc/apt/sources.list.d/volian-archive-scar-unstable.list

    # Update and install
    ${SUDO} apt update
    ${SUDO} apt install -y nala
}
```

### Edge Cases

1. **Not Debian/Ubuntu:** Return early with informative message
2. **curl not available:** Install curl first (dependency)
3. **gpg not available:** Install gpg first (dependency for Volian method)
4. **Network failure:** Handle gracefully with error message
5. **Permission issues:** Use `${SUDO}` variable consistently
6. **Already installed:** Skip with informative message

### Version Detection Logic

The version comparison needs to extract the major version number:
- Debian: `os_version()` returns something like "13" or "12"
- Ubuntu: `os_version()` returns something like "22.04" or "24.04"

For Ubuntu, we need to handle the decimal format:
```bash
local version=$(os_version)
local major_version="${version%%.*}"  # Get major version (22 from 22.04)
```

### Dependencies

- `has_command` from detection.sh
- `is_debian`, `is_ubuntu` from detection.sh
- `os_version` from os.sh
- `logc`, `log` from logging.sh
- `confirm` from interactive.sh
- `${SUDO}` variable (set elsewhere, empty string if root)

---

## Review Findings

**Date:** 2025-12-01

### Code Quality
- [x] Follows existing patterns in `install_*` functions
- [x] Proper documentation comments for both functions
- [x] Uses consistent logging via `logc`
- [x] Proper error handling with return codes

### Potential Improvements

**Recommended:**
- [ ] The `has_command "confirm"` check on line 1080 is unnecessary - `confirm` is a function in `interactive.sh` which is already sourced. Could simplify to just `if confirm "..."`.

**Optional:**
- [ ] Could add a `--skip-fetch` flag to skip the mirror selection prompt for non-interactive use
- [ ] Could detect geographic location for `nala fetch` country code (US vs UK as mentioned in original TODO)

### Test Results
- **Total tests:** 46
- **Passing:** 41
- **Failing:** 5 (same pre-existing failures, no regressions)

### Implementation Summary

Created two functions:
1. `_install_nala_from_volian()` - Helper for Volian Scar repo installation (lines 991-1031)
2. `install_nala()` - Main installation function (lines 1033-1088)

The function:
- Checks if already installed
- Validates OS is Debian/Ubuntu
- Uses official repos for Debian 11+ / Ubuntu 22.04+
- Falls back to Volian Scar for older versions
- Offers optional mirror optimization via `nala fetch`
