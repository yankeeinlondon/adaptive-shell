# Feature: Complete TODO Functions in detection.sh

**Date:** 2025-12-01
**Feature Name:** `detection-todo-functions`

## Feature Description

Complete the implementation of 9 functions in `utils/detection.sh` that are currently marked with `# TODO` comments. These functions provide project and repository detection capabilities:

1. **`is_git_repo`** - Tests if a path is part of a git repository
2. **`repo_is_dirty`** - Tests if git status has uncommitted changes
3. **`repo_root`** - Finds the root directory of a git repo
4. **`is_monorepo`** - Tests if repo is a monorepo (multiple packages/workspaces)
5. **`has_package_json`** - Checks for package.json file
6. **`has_typescript_files`** - Looks for TypeScript files in project
7. **`looks_like_js_project`** - Detects JavaScript/TypeScript projects
8. **`looks_like_rust_project`** - Detects Rust projects
9. **`looks_like_python_project`** - Detects Python projects

## Files Affected

### Modified
- `utils/detection.sh` - Main implementation file

### New (Tests)
- `tests/unit/WIP/detection-todo.test.ts` - New comprehensive tests

## Test Scope

**Glob Pattern:** `tests/detection*.test.ts`

**Test Command:**
```bash
pnpm test tests/detection.test.ts
```

## Baseline Test Status

**Date:** 2025-12-01
**Status:** All passing

| Metric | Count |
|--------|-------|
| Total tests | 37 |
| Passing | 37 |
| Failing | 0 |

**Pre-existing Failures:** None

**Note:** The current tests for TODO functions verify they exist and return failure (exit code 1) since they are not implemented.

## Implementation Checklist

- [x] Step 1: Preparation (identify TODOs, create log, baseline)
- [x] Step 2: Planning (detailed implementation plan)
- [x] Step 3: Unit Tests (via tester sub-agent)
- [x] Step 4: Implementation
- [x] Step 5: Review

---

## Step 2: Planning

### Architecture

The TODO functions fall into three categories:

1. **Git Repository Detection** (`is_git_repo`, `repo_root`, `repo_is_dirty`, `is_monorepo`)
   - Use `git rev-parse` for reliable git detection
   - Handle paths that may or may not exist
   - Avoid infinite recursion (current bug in code)

2. **File/Project Detection** (`has_package_json`, `has_typescript_files`)
   - Check for existence of specific files
   - Search in logical locations (current dir, repo root, src/)
   - Use `find` with depth limits for performance

3. **Project Type Detection** (`looks_like_js_project`, `looks_like_rust_project`, `looks_like_python_project`)
   - Identify projects by characteristic files
   - JS: `package.json`, `.js`/`.ts` files
   - Rust: `Cargo.toml`, `.rs` files
   - Python: `requirements.txt`, `pyproject.toml`, `setup.py`, `.py` files

### Implementation Steps

#### 1. Fix `is_git_repo`
- Remove infinite recursion (currently calls itself)
- Use `git rev-parse --is-inside-work-tree` executed from the target path
- Return 0 if git repo, 1 if not

#### 2. Implement `repo_root`
- Remove infinite recursion
- Use `git rev-parse --show-toplevel` executed from the target path
- Output the path on success, return error code on failure

#### 3. Implement `repo_is_dirty`
- Use `git status --porcelain` to check for changes
- Return 0 if dirty (has changes), 1 if clean

#### 4. Implement `is_monorepo`
- After finding repo root, check for:
  - `pnpm-workspace.yaml`
  - `lerna.json`
  - `packages/` directory with multiple `package.json` files
  - `workspaces` field in root `package.json`

#### 5. Implement `has_package_json`
- Check path directly, then repo root if in a git repo
- Simple file existence check

#### 6. Implement `has_typescript_files`
- Use `find` with limited depth to locate `.ts` or `.tsx` files
- Check path, repo root, and `src/` subdirectory

#### 7. Implement `looks_like_js_project`
- Check for `package.json` (primary indicator)
- Fallback: look for `.js`, `.ts`, `.mjs`, `.cjs` files

#### 8. Implement `looks_like_rust_project`
- Check for `Cargo.toml` (primary indicator)
- Fallback: look for `.rs` files

#### 9. Implement `looks_like_python_project`
- Check for `pyproject.toml`, `requirements.txt`, `setup.py`, `setup.cfg`
- Fallback: look for `.py` files

### Edge Cases

1. **Non-existent paths** - Should return error gracefully
2. **Paths without read permissions** - Should handle gracefully
3. **Nested git repos** - `repo_root` should find the innermost repo
4. **Symlinks** - Should follow symlinks appropriately
5. **Empty directories** - Should not false-positive on project detection
6. **Performance** - Use shallow `find` to avoid scanning huge directories

### Dependencies

- No new dependencies required
- Uses existing utilities: `has_command`, `debug` from logging.sh
- Uses standard Unix tools: `git`, `find`, `grep`

---

## Step 3: Unit Tests

**Total New Tests:** 27 tests added to `tests/detection.test.ts`
**Test Coverage:** All 9 TODO functions now have comprehensive test coverage

Tests cover:
- Positive cases (detecting actual repos/projects)
- Negative cases (non-repo paths, non-existent paths)
- Edge cases (relative paths, subdirectories)
- Error handling (graceful failures)

---

## Step 4: Implementation Notes

### Key Implementation Decisions

1. **Git Commands**: Used `git -C <path>` to execute git commands from specific directories without changing CWD

2. **Pipefail Safety**: All `find` commands use `-print -quit` pattern with `|| true` to avoid issues with bash's `-e` (errexit) mode used in test framework

3. **Path Handling**: All functions handle:
   - Non-existent paths (return 1)
   - File paths (convert to parent directory)
   - Relative and absolute paths

4. **Monorepo Detection**: Checks for:
   - `pnpm-workspace.yaml`
   - `lerna.json`
   - `"workspaces"` field in package.json

5. **Project Detection**: Primary indicators (config files) checked first, with fallback to file extension searches

### Test Fix Required

During testing, discovered that `tests/detection.test.ts` incorrectly assumed this repo was NOT a monorepo. Updated tests to expect `is_monorepo()` to return 0 since `pnpm-workspace.yaml` exists.

---

## Step 5: Review Findings

### Final Test Results

| Metric | Count |
|--------|-------|
| Total tests | 64 |
| Passing | 64 |
| Failing | 0 |

**All detection tests pass.** Pre-existing failures in other test files (typeof.test.ts, etc.) are unrelated to this feature.

### Code Quality

- [x] All functions have clear docstrings
- [x] Consistent error handling pattern across all functions
- [x] Uses existing utilities (`is_git_repo` reused by other functions)
- [x] No infinite recursion bugs (fixed from original broken code)

### Performance Considerations

- [x] `find` commands limited to `-maxdepth 3` to avoid deep scans
- [x] Uses `-quit` to stop on first match
- [x] Primary indicators (config files) checked before file scans

### Potential Improvements (Optional)

- [ ] Consider caching `repo_root` result when called multiple times
- [ ] Add support for more monorepo tools (Nx, Rush, Turborepo)
- [ ] Consider adding `looks_like_go_project()` for Go detection

### Security

- [x] No user input passed to shell without proper quoting
- [x] All external commands use proper error suppression

### Summary

✅ All 9 TODO functions successfully implemented
✅ 64 tests passing (27 new tests added)
✅ No regressions introduced
✅ Robust to errexit mode used in test framework
