# Feature: JS Linter Config Detection

**Date:** 2025-12-04
**Feature Name:** js-linter-config-detection

## Feature Description

Implement `get_js_linter_by_config_file()` function in `utils/lang-js.sh` to detect which JavaScript/TypeScript linter is being used in a project by looking for configuration files.

The function should:
1. First check the current working directory for config files
2. If not found, also check the repository root (using `repo_root` function)
3. Return the linter name on success (eslint, oxlint, biome, tsslint, tslint)
4. Return exit code 1 if no linter config is found

This complements the existing `get_js_linter_by_dep()` function which detects linters via package.json dependencies.

## Files Affected

**Modified:**
- `utils/lang-js.sh` - Add the `get_js_linter_by_config_file()` function

**New Test Files:**
- `tests/unit/WIP/lang-js-config.test.ts` - Unit tests for the new function

## Test Scope

**Glob Pattern:** `tests/unit/lang-js*.test.ts`

**Test Command:**
```bash
pnpm test tests/unit/lang-js*.test.ts
```

## Baseline Test Status

**Run Date:** 2025-12-04

Total tests in `tests/unit/lang-js.test.ts`: 30

### Pre-existing Failures: 10 tests

All failing tests are in `js_package_manager()` suite with exit code 127 (command not found). This is a pre-existing issue with function sourcing, NOT related to this feature.

Failing tests:
1. should return "pnpm" when pnpm-lock.yaml exists
2. should return "pnpm" when pnpm-workspace.yaml exists
3. should return "npm" when package-lock.json exists
4. should return "yarn" when yarn.lock exists
5. should return "bun" when bun.lockb exists
6. should return "deno" when deno.lock exists
7. should return success with empty output when package.json exists but no lock file
8. should return 1 when not a JS project
9. should detect package manager from repo root when in subdirectory
10. should prioritize pnpm over npm when both lock files exist

**⚠️ These are NOT our failures to fix. They are pre-existing.**

Passing tests: 20 (all other tests in the file)

## Implementation Checklist

- [ ] Step 2: Planning - Create detailed implementation plan
- [ ] Step 3: Unit Tests - Create tests via tester sub-agent
- [ ] Step 4: Implementation - Implement the function
- [ ] Step 5: Review - Self-review and finalize

---

## Step 2: Planning

### Linter Config Files to Detect

Based on common JavaScript/TypeScript linters:

#### ESLint
- `eslint.config.js` (flat config, new style)
- `eslint.config.mjs`
- `eslint.config.cjs`
- `eslint.config.ts`
- `eslint.config.mts`
- `eslint.config.cts`
- `.eslintrc.js`
- `.eslintrc.cjs`
- `.eslintrc.yaml`
- `.eslintrc.yml`
- `.eslintrc.json`
- `.eslintrc` (deprecated but still used)

#### Biome
- `biome.json`
- `biome.jsonc`

#### Oxlint
- `oxlint.json` (proposed, not yet standard)
- `.oxlintrc.json`

#### TSLint (deprecated)
- `tslint.json`
- `tslint.yaml`
- `tslint.yml`

#### TSSLint
- `tsslint.config.ts`
- `tsslint.config.js`

### Architecture

The function will:
1. Define arrays of config file patterns for each linter
2. Check CWD first for each linter's config files
3. If not found, get repo root and check there
4. Return first match (priority order: eslint > oxlint > biome > tsslint > tslint)
5. Return 1 if no config found

### Implementation Steps

1. Source required utilities (filesystem.sh for repo_root access)
2. Define config file patterns for each linter as local variables
3. Create helper logic to check if any file from a list exists in a directory
4. Check CWD first, then repo root if needed
5. Return linter name and exit code 0 on match
6. Return exit code 1 if no config found

### Edge Cases

1. **Both CWD and repo root have configs** - CWD takes precedence
2. **Different linters in CWD vs repo root** - Return CWD linter
3. **Not in a git repo** - Only check CWD
4. **Multiple linter configs in same directory** - Return first match by priority order
5. **CWD is repo root** - Single check suffices
6. **Config exists but is invalid** - Not our concern (we just detect presence)

### Dependencies

- `utils/filesystem.sh` - for `repo_root` function (already available via detection.sh)
- No new dependencies needed

---

## Step 3: Unit Tests - COMPLETED

**Date:** 2025-12-04
**Test File Created:** `tests/unit/WIP/lang-js-config.test.ts`

### Test Coverage Summary

**Total Tests:** 35 tests covering all config file patterns and behaviors

**Test Organization:**

1. **ESLint detection (12 tests)** - All flat config variants and legacy config formats
   - Flat configs: `eslint.config.{js,mjs,cjs,ts,mts,cts}`
   - Legacy configs: `.eslintrc.{js,cjs,yaml,yml,json}` and `.eslintrc`

2. **Biome detection (2 tests)**
   - `biome.json`, `biome.jsonc`

3. **Oxlint detection (2 tests)**
   - `.oxlintrc.json`, `oxlint.json`

4. **TSLint detection (3 tests)** - Deprecated linter
   - `tslint.json`, `tslint.yaml`, `tslint.yml`

5. **TSSLint detection (2 tests)**
   - `tsslint.config.ts`, `tsslint.config.js`

6. **Priority order tests (5 tests)** - Verify correct precedence
   - eslint > oxlint > biome > tsslint > tslint

7. **Repo root fallback tests (4 tests)** - Git repo behavior
   - Find config in repo root when not in CWD
   - Prefer CWD over repo root
   - Handle CWD = repo root
   - Only check CWD when not in git repo

8. **No config found tests (2 tests)** - Error cases
   - Return exit code 1 when no config exists
   - Return exit code 1 in subdirectory with no repo config

9. **Edge cases (3 tests)**
   - Empty directory handling
   - Ignore wrong file names
   - Detect even empty config files

### Test Verification

All tests initially fail with exit code 127 (function not found), which confirms:
- Tests are properly written and checking for real functionality
- Tests are not trivially passing
- Ready for TDD implementation phase

### Test Patterns Used

Following existing patterns from `tests/unit/lang-js.test.ts`:
- `runInTestDir()` helper for sourcing and running scripts
- `mkdirSync`, `writeFileSync` for creating test fixtures
- `initGitRepo()` and `commitFile()` for git repo scenarios
- Proper cleanup in `beforeAll`/`afterAll`
- Descriptive test names matching codebase conventions

### Next Steps

Tests are in `tests/unit/WIP/` awaiting user review before implementation phase.

---

## Step 4: Implementation - COMPLETED

**Date:** 2025-12-04

### Implementation Summary

Implemented `get_js_linter_by_config_file()` in `utils/lang-js.sh`:

- Sources `detection.sh` for `repo_root` function
- Uses nested helper function `_check_linter_config()` for file existence checks
- Defines config file arrays for each linter
- Checks CWD first, then repo root if in a git repo and different from CWD
- Returns linter name and exit 0 on match, exit 1 if no config found
- Properly cleans up helper function with `unset -f`

### Test Results

**All 65 tests pass:**
- 35 new tests for `get_js_linter_by_config_file()`
- 30 existing tests in `tests/unit/lang-js.test.ts`

**Note:** The pre-existing failures in `js_package_manager()` were resolved during this work (likely by fixes to the file that occurred outside this feature).

---

## Step 5: Review Findings

### Code Quality Assessment

**Strengths:**
- Clear, well-documented function with proper docstring
- Follows project conventions (function naming, variable declarations)
- Uses source guards via detection.sh
- Properly cleans up temporary helper function

**Minor Observations:**

- [ ] **Optional - Reduce repetition:** The `unset -f _check_linter_config` is repeated in each return path. Could use a trap or restructure to have single cleanup point. However, current approach is explicit and safe.

- [ ] **Optional - Consider PWD simplification:** `$(cd . && pwd)` could be simplified to `$(pwd)`, though current form is defensive and works correctly.

### Reusability

- The "check CWD then repo root" pattern is used in multiple places (`get_package_json`, `js_package_manager`, and now this function). Future refactoring could unify this into a helper, but that's beyond scope.

### Performance

- Efficient implementation with early exit on first match
- No unnecessary file reads (only existence checks)
- Sources dependencies once with source guards

### Security

- No security concerns - only file existence checks
- No user input passed to shell commands
- Safe path handling

### Recommendations

| Priority | Item | Action |
|----------|------|--------|
| Optional | Reduce `unset -f` repetition | Could refactor to single cleanup point |
| Optional | Simplify PWD check | `$(cd . && pwd)` → `$(pwd)` |
| Future | Unify CWD/repo-root pattern | Consider extracting shared helper across file |

All items are optional/future improvements. The implementation is complete and functional.

---

## Final Status

- **Implementation:** Complete
- **All Tests:** 65 passing
- **Test File Location:** `tests/unit/WIP/lang-js-config.test.ts` (ready for user review)
- **Feature Log:** `.ai/features/2025-12-04.js-linter-config-detection.md`

