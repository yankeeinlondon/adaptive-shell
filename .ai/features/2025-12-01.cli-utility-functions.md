# Feature: CLI Utility Functions

**Date:** 2025-12-01
**Feature Name:** cli-utility-functions

## Feature Description

Implement a set of CLI argument parsing utility functions in `utils/cli.sh` that provide reusable functionality for detecting and extracting command-line switches and parameters. The functions stub is already defined in the file and includes:

1. **`cli_json()`** - Detects if `--json` flag is present in arguments
2. **`cli_verbose()`** - Detects if `--verbose` or `-v` flags are present in arguments
3. **`cli_force()`** - Detects if `--force` flag is present in arguments
4. **`non_switch_params()`** - Extracts only non-switch parameters (strips `--*` and `-*` switches)
5. **`switch_params()`** - Extracts only switch parameters (`--*` and `-*` flags)

These utilities will help standardize CLI argument handling across the shell scripts in this repository.

## Files Affected

### Files to Modify
- `utils/cli.sh` - Implement the 5 stub functions

### Files to Create
- `tests/unit/WIP/cli.test.ts` - Unit tests for the CLI utilities

## Test Scope

**Glob Pattern:** `tests/**/cli*.test.ts`

**Test Command:**
```bash
pnpm test tests/unit/WIP/cli.test.ts
```

## Baseline Test Status

**Date:** 2025-12-01

- **Total tests in scope:** 0 (new feature, no existing tests)
- **Passing:** N/A
- **Failing:** N/A
- **Pre-existing failures:** None

**Full test suite baseline:**
- Total tests: 586
- Passing: 566
- Skipped: 20
- All test files: 16 passed

## Architecture & Design

### Function Signatures

Based on the existing stub documentation in `utils/cli.sh`, here are the implementations:

#### 1. `cli_json()`
```bash
# cli_json() -> boolean
#
# returns true/false based on whether the `--json`
# flag was found in the arguments passed in.
function cli_json() {
    local -ra arguments=("${@}")
    # Iterate through arguments looking for --json
}
```

**Behavior:**
- Return 0 (true) if `--json` is found in arguments
- Return 1 (false) otherwise
- Simple flag detection, no value expected

#### 2. `cli_verbose()`
```bash
# cli_verbose(params) -> boolean
#
# returns true/false based on whether the `--verbose` or `-v`
# flags were found in the arguments passed in.
function cli_verbose() {
    local -ra arguments=("${@}")
    # Iterate through arguments looking for --verbose or -v
}
```

**Behavior:**
- Return 0 (true) if `--verbose` OR `-v` is found
- Return 1 (false) otherwise
- Note: `-v` should match exactly, not as part of combined short flags like `-vvv`

#### 3. `cli_force()`
```bash
# cli_force() -> boolean
#
# returns true/false based on whether the `--force`
# flag was found in the arguments passed in.
function cli_force() {
    local -ra arguments=("${@}")
    # Iterate through arguments looking for --force
}
```

**Behavior:**
- Return 0 (true) if `--force` is found
- Return 1 (false) otherwise

#### 4. `non_switch_params()`
```bash
# non_switch_params()
#
# strips out all CLI switch/flags (e.g., '--${string}' or '-${string}')
# from the a set of arguments leaving only the non-switch based params.
#
# - takes either an array of arguments, or
#   a reference to an array of arguments
# - if a reference is passed in then the array
#   will be mutated in place
# - if arguments are passed by value then
#   the updated array will be returned.
function non_switch_params() {
    # Implementation supports both reference and value passing
}
```

**Behavior:**
- Filter out arguments starting with `-` or `--`
- Support pass-by-value: `non_switch_params "file.txt" "--verbose" "output.txt"` -> outputs `file.txt output.txt`
- Support pass-by-reference: `non_switch_params arr` (modifies arr in place)
- Output: newline-separated values (for easy iteration)

#### 5. `switch_params()`
```bash
# switch_params()
#
# Strips out all parameters which are NOT CLI switch/flags
# (e.g., '--${string}' or '-${string}').
#
# - takes either an array of arguments, or
#   a reference to an array of arguments
# - if a reference is passed in then the array
#   will be mutated in place
# - if arguments are passed by value then
#   the updated array will be returned.
function switch_params() {
    # Implementation supports both reference and value passing
}
```

**Behavior:**
- Keep ONLY arguments starting with `-` or `--`
- Support pass-by-value and pass-by-reference (like `non_switch_params`)
- Output: newline-separated values

### Implementation Approach

1. **Flag detection functions** (`cli_json`, `cli_verbose`, `cli_force`):
   - Simple loop over `"${@}"` checking for exact matches
   - Return 0/1 based on presence

2. **Parameter filtering functions** (`non_switch_params`, `switch_params`):
   - Detect if first argument is a variable name (nameref) or a direct value
   - For nameref: use `local -n` to modify in place
   - For direct values: loop and echo matching items

### Edge Cases

1. **Empty arguments** - All functions should handle gracefully
2. **`--` separator** - Standard convention to end option parsing (consider for future enhancement)
3. **Combined short flags** - `-vf` should NOT match `-v` (exact match only)
4. **Arguments with spaces** - Should be preserved correctly
5. **Arguments that look like flags but aren't** - `"--verbose"` as a string value after `--` separator

### Dependencies

The file already sources `utils/logging.sh` for `debug()` function access.

## Implementation Checklist

- [x] Step 2: Planning - Design implementation approach
- [x] Step 3: Unit Tests - Create tests via tester sub-agent
- [x] Step 4: Implementation - Implement CLI utility functions
- [x] Step 5: Review - Self-review and document findings

## Test Details

- **Test File:** `tests/cli.test.ts`
- **Total Tests:** 53
- **Status:** All passing

## Review Findings

### Code Quality

**Strengths:**
- Clean, readable implementations following project conventions
- Proper use of local variables
- Consistent pattern across all boolean detection functions
- Good documentation comments matching existing style

**No Issues Found:**
- Functions are simple and focused
- No complex logic requiring additional comments
- Error handling is appropriate (return 1 for not found)

### Reusability & Dependencies

- [x] No external dependencies needed
- [x] Functions are self-contained and reusable
- [x] Pass-by-reference pattern uses `local -n` (nameref) which is Bash 4.3+ compatible

### Performance

- [x] No performance concerns - simple O(n) iteration
- [x] Early return on match in boolean functions
- [x] No unnecessary allocations

### Security

- [x] No command injection vulnerabilities
- [x] No unsafe evals or indirect execution
- [x] Input is properly quoted

### Potential Future Enhancements (Optional)

- [ ] **Support for `--` separator**: Standard convention to end option parsing (e.g., `git checkout -- file.txt`). Currently not implemented but could be added if needed.
- [ ] **Generic flag detection function**: Could add `cli_has_flag()` that takes flag name as parameter to reduce duplication.

### Final Status

**Implementation Complete:**
- All 5 functions implemented
- All 53 unit tests passing
- No regressions in existing tests (639 total tests pass)
- Code follows project conventions
