# Feature: Add Global Package Listing for uv, pnpm, and bun

## Feature Description

Add support for listing globally installed packages from three additional package managers to the `show_installed()` function in `utils/install.sh`:

1. **uv** - Python tools installed via `uv tool install`
2. **pnpm** - Global packages installed via `pnpm add -g`
3. **bun** - Global packages installed via `bun add -g`

This complements the existing support for npm, pip, cargo, gem, nix, and system package managers.

## Files Affected

- **Modified:** `utils/install.sh` - Add `installed_uv()`, `installed_pnpm()`, `installed_bun()` functions and update `show_installed()`
- **Modified:** `tests/install.test.ts` - Add tests for new functions
- **Modified:** `tests/helpers/install-mocks.sh` - Add mock support for uv, pnpm, bun

## Test Scope

```bash
pnpm test tests/install.test.ts
```

Glob pattern: `tests/install.test.ts`

## Baseline Test Status

- **Total tests:** 42
- **Passing:** 37
- **Failing:** 5 (pre-existing failures in "installed package listing" tests - related to test expectations for color/link formatting, not functionality)

### Pre-existing Failures (NOT to fix):
1. `installed package listing > installed_cargo should list and link packages` - expects `[cargo]` but gets colored output
2. `installed package listing > installed_brew should list formulae and casks` - expects `[brew]` but gets colored output
3. `installed package listing > installed should aggregate multiple managers` - exit code 127
4. `installed package listing > should filter output when arguments are provided` - exit code 127
5. `installed package listing > should handle case-insensitive filtering` - exit code 127

## Implementation Checklist

- [x] Step 2: Planning - Design solution and get user approval
- [x] Step 3: Unit Tests - Write tests via sub-agent
- [x] Step 4: Implementation - Add uv, pnpm, bun to show_installed()
- [x] Step 5: Review - Self-review for quality

---

## Step 2: Planning

### Architecture

Follow the existing pattern for `installed_*` functions:
1. Check if command exists using `has_command`
2. List installed packages using the appropriate command
3. Pipe through `_filter_and_link` to add hyperlinks and apply filters

### Implementation Steps

1. **Research commands** to list global packages for each tool:
   - `uv tool list` - lists tools installed via uv
   - `pnpm list -g --depth=0` - lists global pnpm packages
   - `bun pm ls -g` - lists global bun packages

2. **Create `installed_uv()` function:**
   ```bash
   function installed_uv() {
       if ! has_command "uv"; then return; fi
       uv tool list 2>/dev/null | awk '{print $1}' | \
           _filter_and_link "uv" "https://pypi.org/project/{{PKG}}" "" "$@"
   }
   ```

3. **Create `installed_pnpm()` function:**
   ```bash
   function installed_pnpm() {
       if ! has_command "pnpm"; then return; fi
       pnpm list -g --depth=0 --parseable 2>/dev/null | \
           tail -n +2 | \
           awk -F'/node_modules/' '{if (NF>1) print $NF; else { n=split($0, a, "/"); print a[n] }}' | \
           _filter_and_link "pnpm" "https://www.npmjs.com/package/{{PKG}}" "" "$@"
   }
   ```

4. **Create `installed_bun()` function:**
   ```bash
   function installed_bun() {
       if ! has_command "bun"; then return; fi
       bun pm ls -g 2>/dev/null | grep -E '^\w' | awk '{print $1}' | \
           _filter_and_link "bun" "https://www.npmjs.com/package/{{PKG}}" "" "$@"
   }
   ```

5. **Update `show_installed()` function** to call the new functions

6. **Update mock infrastructure** to support uv, pnpm, bun

### Type Definitions

N/A - This is bash shell script

### Edge Cases

1. **Empty package lists** - handled by existing `_filter_and_link` function
2. **Command not available** - early return with `has_command` check
3. **Scoped packages** (e.g., `@org/pkg`) - pnpm/bun use same npm registry, handled like npm

### Dependencies

- No new dependencies
- Leverages existing `_filter_and_link` helper function

### Package URL References

- **uv tools** → PyPI: `https://pypi.org/project/{{PKG}}`
- **pnpm global** → npm registry: `https://www.npmjs.com/package/{{PKG}}`
- **bun global** → npm registry: `https://www.npmjs.com/package/{{PKG}}`

---

## Final Implementation

### Functions Added (utils/install.sh)

1. **`installed_uv()`** (lines 516-526)
   - Uses `uv tool list` and filters out command entries (lines starting with `-`)
   - Links to PyPI

2. **`installed_pnpm()`** (lines 488-499)
   - Uses `pnpm list -g --depth=0` (non-parseable format)
   - Extracts only direct dependencies from the `dependencies:` section
   - Links to npm registry

3. **`installed_bun()`** (lines 501-507)
   - Uses `bun pm ls -g` and parses tree output (`└──` and `├──`)
   - Handles scoped packages correctly (`@org/pkg`)
   - Links to npm registry

4. **`show_installed()`** updated to include all three new functions

### Tests Added (tests/install.test.ts)

- `installed_uv should list uv tools with PyPI links`
- `installed_pnpm should list pnpm global packages with npm links`
- `installed_bun should list bun global packages with npm links`
- `show_installed should include uv, pnpm, and bun packages`

### Mocks Added (tests/helpers/install-mocks.sh)

- `uv()` mock with `_fmt_uv` formatter
- `pnpm()` mock with `_fmt_pnpm` formatter
- `bun()` mock with `_fmt_bun` formatter

---

## Test Results

- **Total tests:** 46 (up from 42)
- **Passing:** 41 (up from 37)
- **Failing:** 5 (same pre-existing failures)
- **New tests:** 4 (all passing)

---

## Review Findings

### Completed
- [x] All functions follow existing patterns
- [x] Error handling via `has_command` check
- [x] Scoped packages handled correctly (tested with `@org/pkg`)
- [x] Empty lists handled gracefully by `_filter_and_link`

### Optional Improvements (not critical)
- [ ] Consider adding `installed_yarn` for completeness (yarn global packages)
- [ ] The pre-existing test failures should be fixed separately (tests expect `[cargo]` but get ANSI-colored output)
