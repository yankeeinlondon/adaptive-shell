# Code Review: `update_packages()` and `upgrade_packages()` in utils/install.sh

**File:** `utils/install.sh` (lines 1339-1401)
**Date:** 2025-12-01
**Reviewer:** Claude Code

---

## Must Fix

### 1. Incorrect command syntax for most package managers

**Lines:** 1352-1366, 1386-1400

Most of the package manager commands use incorrect syntax:

| Package Manager | Current (Wrong) | Correct |
|-----------------|-----------------|---------|
| `pacman` | `pacman update` | `pacman -Sy` (sync) |
| `pacman` | `pacman upgrade -y` | `pacman -Syu --noconfirm` |
| `yay` | `yay update` | `yay -Sy` |
| `yay` | `yay upgrade -y` | `yay -Syu --noconfirm` |
| `paru` | `paru update` | `paru -Sy` |
| `paru` | `paru upgrade -y` | `paru -Syu --noconfirm` |
| `brew` | `brew upgrade -y` | `brew upgrade` (no `-y` flag) |

These will fail at runtime. Example fix for `update_packages()`:

```bash
if has_command "pacman"; then
    ${SUDO} pacman -Sy
fi
```

### 2. Missing `${SUDO}` for commands requiring root privileges

**Lines:** 1342-1344, 1350, 1353-1360, 1376-1378, 1384, 1387-1394

Unlike other `install_on_*` functions in this file which correctly use `${SUDO}`, these functions omit it. Commands like `apt update`, `dnf update`, `apk update`, etc. require root privileges on most systems.

```bash
# Current (missing sudo)
apt update

# Should be
${SUDO} apt update
```

---

## Suggested Improvements

### 3. Documentation mismatch for `upgrade_packages()`

**Lines:** 1369-1372

The doc comment says "update_packages" but the function is `upgrade_packages()`:

```bash
# Current
# update_packages
#
# updates all packages from the package managers

# Should be
# upgrade_packages
#
# Upgrades all packages from the package managers
# which are installed on the system.
```

### 4. Consider returning meaningful exit codes

Currently both functions silently continue if any package manager fails. Consider:

```bash
function update_packages() {
    local -i failed=0

    if has_command "apt"; then
        ${SUDO} apt update || ((failed++))
    fi
    # ... other managers

    return $((failed > 0 ? 1 : 0))
}
```

### 5. Consider adding user feedback via `logc`

Other functions in this file use `logc` for status messages. These functions are silent, which may confuse users on slow networks:

```bash
if has_command "brew"; then
    logc "- updating {{BOLD}}brew{{RESET}} packages..."
    brew update
fi
```

### 6. Redundant yay/paru with pacman

**Lines:** 1361-1366, 1395-1400

If `yay` or `paru` is installed, calling both the AUR helper AND `pacman` is redundant since AUR helpers wrap pacman. Typically you'd use one or the other:

```bash
if has_command "yay"; then
    ${SUDO} yay -Sy
elif has_command "paru"; then
    ${SUDO} paru -Sy
elif has_command "pacman"; then
    ${SUDO} pacman -Sy
fi
```

---

## Nits

### 7. Empty line after function declaration

**Lines:** 1340, 1374

Minor inconsistency - there's a blank line after the opening brace. Not wrong, just inconsistent with other functions in the file.

### 8. Consider a helper for update/upgrade logic

Given the repetitive pattern, a helper could reduce duplication:

```bash
# _run_pkg_command <check_cmd> <actual_cmd> [args...]
function _run_pkg_command() {
    local check_cmd="$1"
    shift
    if has_command "$check_cmd"; then
        "$@"
    fi
}
```

---

## Positive Observations

1. **Good pattern for nala/apt fallback** (lines 1341-1345, 1375-1379) - correctly prefers nala over apt with `elif`.

2. **Consistent with file conventions** - follows the same function naming and structure as other functions in install.sh.

3. **Clear intent** - the functions clearly communicate their purpose even if implementation has issues.

---

## Summary

The primary issues are incorrect command syntax for Arch-based package managers (pacman/yay/paru) and brew, plus missing `${SUDO}` for privileged operations. These will cause runtime failures. The documentation typo and redundant AUR helper calls are secondary concerns.
